Import('env')

env_thirdparty = env.Clone()

if env["disable_exceptions"]:
    # If exceptions were disabled, we have to undo this when compiling the thirdparty code.
    if env.msvc:
        env_thirdparty["CPPDEFINES"] = [x for x in env_thirdparty["CPPDEFINES"] if "_HAS_EXCEPTIONS" not in x]
        env_thirdparty.Append(CCFLAGS=["/EHsc"])
    else:
        env_thirdparty["CCFLAGS"] = [x for x in env_thirdparty["CCFLAGS"] if "-fno-exceptions" not in x]

# Add all .cpp files in the current directory to the environment
src_list = [
    "thirdparty/libriscv/lib/libriscv/cpu.cpp",
    "thirdparty/libriscv/lib/libriscv/debug.cpp",
    "thirdparty/libriscv/lib/libriscv/decode_bytecodes.cpp",
    "thirdparty/libriscv/lib/libriscv/decoder_cache.cpp",
    "thirdparty/libriscv/lib/libriscv/machine.cpp",
    "thirdparty/libriscv/lib/libriscv/machine_defaults.cpp",
    "thirdparty/libriscv/lib/libriscv/memory.cpp",
    "thirdparty/libriscv/lib/libriscv/memory_elf.cpp",
    "thirdparty/libriscv/lib/libriscv/memory_mmap.cpp",
    "thirdparty/libriscv/lib/libriscv/memory_rw.cpp",
    "thirdparty/libriscv/lib/libriscv/multiprocessing.cpp",
    "thirdparty/libriscv/lib/libriscv/native_libc.cpp",
    "thirdparty/libriscv/lib/libriscv/rv64i.cpp",
    "thirdparty/libriscv/lib/libriscv/native_threads.cpp",
    "thirdparty/libriscv/lib/libriscv/posix/minimal.cpp",
    "thirdparty/libriscv/lib/libriscv/posix/signals.cpp",
    "thirdparty/libriscv/lib/libriscv/posix/threads.cpp",
    "thirdparty/libriscv/lib/libriscv/posix/socket_calls.cpp",
    "thirdparty/libriscv/lib/libriscv/serialize.cpp",
    "thirdparty/libriscv/lib/libriscv/util/crc32c.cpp",
]

if env_thirdparty['platform'] == 'osx':
    pass

env_thirdparty.add_source_files(env_thirdparty.modules_sources, src_list)

# Specify the include directories
env_thirdparty.Append(CPPPATH=[".", "#modules/riscv", "libriscv", "thirdparty/libriscv/lib/libriscv/linux", "thirdparty/libriscv/lib/libriscv/posix", "thirdparty/libriscv/lib/libriscv/util"])

env.modules_sources += src_list

# Specify the library paths and link flags if needed
# env.Append(LIBPATH=["path/to/libs"])
# env.Append(LINKFLAGS=["-lmylib"])

# If there are any specific C++ flags you want to add, you can use the following line
# env.Append(CXXFLAGS=["-std=c++20"])
